{% extends 'base.html' %}

{% block title %}Stock Orders{% endblock %}
{% block page_title %}Stock Orders{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-robot"></i> AI Stock Suggestions</span>
        <button type="button" class="btn btn-outline-info btn-sm" id="btnAiStockSuggestions">
            <i class="bi bi-lightbulb"></i> Get AI Suggestions
        </button>
    </div>
    <div class="card-body d-none" id="stockSuggestionsContent">
        <div id="stockSuggestionsLoading" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Analyzing stock levels...</p>
        </div>
        <div id="stockSuggestionsResult"></div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-box-seam"></i> Stock Orders</span>
        <a href="{% url 'finance:stock_order_create' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg"></i> New Order
        </a>
    </div>
    <div class="card-body">
        <table class="table table-hover data-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Supplier</th>
                    <th>Order Date</th>
                    <th>Expected</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td><code>{{ order.order_number }}</code></td>
                    <td>{{ order.supplier.name }}</td>
                    <td>{{ order.order_date }}</td>
                    <td>{{ order.expected_delivery|default:"-" }}</td>
                    <td>${{ order.total_amount|floatformat:2 }}</td>
                    <td>
                        {% if order.status == 'pending' %}
                        <span class="badge bg-secondary">Pending</span>
                        {% elif order.status == 'ordered' %}
                        <span class="badge bg-primary">Ordered</span>
                        {% elif order.status == 'shipped' %}
                        <span class="badge bg-info">Shipped</span>
                        {% elif order.status == 'delivered' %}
                        <span class="badge bg-success">Delivered</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="{% url 'finance:stock_order_items' order.pk %}" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if order.status == 'pending' %}
                            <a href="{% url 'finance:stock_order_status' order.pk 'ordered' %}" class="btn btn-outline-success btn-action" title="Mark Ordered">
                                <i class="bi bi-send"></i>
                            </a>
                            {% elif order.status == 'ordered' %}
                            <a href="{% url 'finance:stock_order_status' order.pk 'delivered' %}" class="btn btn-outline-success btn-action" title="Mark Delivered">
                                <i class="bi bi-check"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center">No stock orders found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btnAiStockSuggestions').addEventListener('click', function() {
    const btn = this;
    const contentDiv = document.getElementById('stockSuggestionsContent');
    const loadingDiv = document.getElementById('stockSuggestionsLoading');
    const resultDiv = document.getElementById('stockSuggestionsResult');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';
    contentDiv.classList.remove('d-none');
    loadingDiv.classList.remove('d-none');
    resultDiv.innerHTML = '';
    
    fetch('/ai/api/stock-suggestions/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Get AI Suggestions';
        loadingDiv.classList.add('d-none');
        
        if (data.success) {
            let html = '';
            
            if (data.summary) {
                html += `<div class="alert alert-info mb-3"><i class="bi bi-info-circle"></i> ${data.summary}</div>`;
            }
            
            if (data.suggestions && data.suggestions.length > 0) {
                html += '<table class="table table-sm">';
                html += '<thead><tr><th>Item</th><th>Current</th><th>Suggested Order</th><th>Priority</th><th>Reasoning</th></tr></thead>';
                html += '<tbody>';
                
                data.suggestions.forEach(s => {
                    let priorityClass = 'bg-secondary';
                    if (s.priority === 'high') priorityClass = 'bg-danger';
                    else if (s.priority === 'medium') priorityClass = 'bg-warning text-dark';
                    else if (s.priority === 'low') priorityClass = 'bg-success';
                    
                    html += `<tr>
                        <td>${s.item_name}</td>
                        <td>${s.current_stock}</td>
                        <td><strong>${s.suggested_order}</strong></td>
                        <td><span class="badge ${priorityClass}">${s.priority || 'N/A'}</span></td>
                        <td><small>${s.reasoning || ''}</small></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p class="text-muted">No stock suggestions at this time. Stock levels appear adequate.</p>';
            }
            
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error || 'Failed to get AI suggestions'}</div>`;
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Get AI Suggestions';
        loadingDiv.classList.add('d-none');
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</div>`;
    });
});
</script>
{% endblock %}
