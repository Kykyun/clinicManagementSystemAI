{% extends 'base.html' %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}
{% block page_title %}Invoice Details{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-receipt"></i> Invoice {{ invoice.invoice_number }}
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Patient</h6>
                        <p>{{ invoice.patient.full_name }}<br>
                        {{ invoice.patient.phone }}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p><strong>Date:</strong> {{ invoice.invoice_date|date:"M d, Y" }}<br>
                        <strong>Due:</strong> {{ invoice.due_date|default:"N/A" }}</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.description }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>${{ item.unit_price|floatformat:2 }}</td>
                            <td>${{ item.total|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">No items</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                            <td>${{ invoice.subtotal|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end">Discount:</td>
                            <td>-${{ invoice.discount|floatformat:2 }}</td>
                        </tr>
                        <tr class="table-primary">
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td><strong>${{ invoice.total_amount|floatformat:2 }}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end">Paid:</td>
                            <td>${{ invoice.amount_paid|floatformat:2 }}</td>
                        </tr>
                        <tr class="table-warning">
                            <td colspan="3" class="text-end"><strong>Balance:</strong></td>
                            <td><strong>${{ invoice.outstanding_balance|floatformat:2 }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-credit-card"></i> Payment History
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pay in payments %}
                        <tr>
                            <td>{{ pay.payment_date|date:"M d, Y H:i" }}</td>
                            <td>${{ pay.amount|floatformat:2 }}</td>
                            <td>{{ pay.get_payment_method_display }}</td>
                            <td>{{ pay.reference_number|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">No payments recorded.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Status</div>
            <div class="card-body">
                {% if invoice.status == 'pending' %}
                <span class="badge bg-warning fs-6">Pending</span>
                {% elif invoice.status == 'partial' %}
                <span class="badge bg-info fs-6">Partially Paid</span>
                {% elif invoice.status == 'paid' %}
                <span class="badge bg-success fs-6">Paid</span>
                {% endif %}
            </div>
        </div>
        
        {% if invoice.outstanding_balance > 0 %}
        <div class="card mt-3">
            <div class="card-body">
                <a href="{% url 'finance:payment_create' invoice.pk %}" class="btn btn-success w-100">
                    <i class="bi bi-cash"></i> Record Payment
                </a>
            </div>
        </div>
        {% endif %}
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-file-earmark-text"></i> E-Invoice (MyInvois)
            </div>
            <div class="card-body">
                {% if invoice.einvoice_documents.exists %}
                    {% with einvoice=invoice.einvoice_documents.first %}
                    <p class="mb-2">
                        <strong>Status:</strong>
                        {% if einvoice.status == 'pending' %}
                        <span class="badge bg-warning">Pending</span>
                        {% elif einvoice.status == 'submitted' %}
                        <span class="badge bg-info">Submitted</span>
                        {% elif einvoice.status == 'valid' %}
                        <span class="badge bg-success">Valid</span>
                        {% elif einvoice.status == 'invalid' or einvoice.status == 'rejected' %}
                        <span class="badge bg-danger">{{ einvoice.get_status_display }}</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ einvoice.get_status_display }}</span>
                        {% endif %}
                    </p>
                    <a href="{% url 'einvoice:detail' einvoice.pk %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-eye"></i> View E-Invoice
                    </a>
                    {% endwith %}
                {% else %}
                <p class="text-muted small mb-2">No e-invoice generated yet.</p>
                <a href="{% url 'einvoice:create_from_invoice' invoice.pk %}" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-plus-circle"></i> Generate E-Invoice
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
