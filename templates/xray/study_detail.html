{% extends 'base.html' %}
{% block title %}X-Ray Study - {{ study.patient.name }}{% endblock %}
{% block page_title %}X-Ray Study{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'xray:dashboard' %}">X-Ray</a></li>
                <li class="breadcrumb-item active">Study #{{ study.pk }}</li>
            </ol>
        </nav>
        <h1 class="page-title">{{ study.get_body_region_display }} X-Ray</h1>
    </div>
    <div class="d-flex gap-2">
        {% if study.status == 'pending' or study.status == 'in_progress' %}
        {% if images %}
        <a href="{% url 'xray:ai_analyze' study.pk %}" class="btn btn-info">
            <i class="bi bi-robot"></i> Request AI Analysis
        </a>
        {% endif %}
        {% endif %}
        {% if study.status == 'reported' and not report.verified_at %}
        <a href="{% url 'xray:verify_report' study.pk %}" class="btn btn-success">
            <i class="bi bi-check-circle"></i> Verify Report
        </a>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-person me-2"></i>Patient Information</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Name</dt>
                    <dd class="col-7">
                        <a href="{% url 'patients:patient_detail' study.patient.id %}">{{ study.patient.name }}</a>
                    </dd>
                    <dt class="col-5">ID</dt>
                    <dd class="col-7">{{ study.patient.patient_id }}</dd>
                    <dt class="col-5">IC/Passport</dt>
                    <dd class="col-7">{{ study.patient.ic_number|default:"-" }}</dd>
                    <dt class="col-5">Age/Gender</dt>
                    <dd class="col-7">{{ study.patient.age|default:"-" }} / {{ study.patient.gender|default:"-" }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>Study Details</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Date</dt>
                    <dd class="col-7">{{ study.study_date|date:"Y-m-d H:i" }}</dd>
                    <dt class="col-5">Body Region</dt>
                    <dd class="col-7">{{ study.get_body_region_display }}</dd>
                    <dt class="col-5">View Type</dt>
                    <dd class="col-7">{{ study.get_view_type_display }}</dd>
                    <dt class="col-5">Side</dt>
                    <dd class="col-7">{{ study.get_side_display }}</dd>
                    <dt class="col-5">Priority</dt>
                    <dd class="col-7">
                        {% if study.priority == 'stat' %}
                        <span class="badge bg-danger">STAT</span>
                        {% elif study.priority == 'urgent' %}
                        <span class="badge bg-warning text-dark">Urgent</span>
                        {% else %}
                        <span class="badge bg-secondary">Routine</span>
                        {% endif %}
                    </dd>
                    <dt class="col-5">Status</dt>
                    <dd class="col-7">
                        {% if study.status == 'pending' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                        {% elif study.status == 'in_progress' %}
                        <span class="badge bg-info">In Progress</span>
                        {% elif study.status == 'ai_analyzed' %}
                        <span class="badge bg-primary">AI Analyzed</span>
                        {% elif study.status == 'reported' %}
                        <span class="badge bg-success">Reported</span>
                        {% elif study.status == 'verified' %}
                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verified</span>
                        {% endif %}
                    </dd>
                    <dt class="col-5">Requesting Dr</dt>
                    <dd class="col-7">{{ study.requesting_doctor.get_full_name|default:"-" }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-chat-left-text me-2"></i>Clinical Information</h5>
            </div>
            <div class="card-body">
                <h6 class="text-secondary small">Clinical Indication</h6>
                <p>{{ study.clinical_indication }}</p>
                {% if study.clinical_history %}
                <h6 class="text-secondary small mt-3">Clinical History</h6>
                <p class="mb-0">{{ study.clinical_history }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-image me-2"></i>X-Ray Images</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                    <i class="bi bi-upload"></i> Upload Image
                </button>
            </div>
            <div class="card-body">
                {% if images %}
                <div class="row g-3">
                    {% for img in images %}
                    <div class="col-md-4">
                        <div class="card h-100">
                            <a href="{{ img.image.url }}" target="_blank">
                                <img src="{{ img.image.url }}" class="card-img-top" alt="X-ray image" 
                                     style="height: 200px; object-fit: cover;">
                            </a>
                            <div class="card-body p-2">
                                <small class="text-secondary">
                                    {{ img.description|default:"X-ray image" }}<br>
                                    {{ img.uploaded_at|date:"Y-m-d H:i" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-secondary">
                    <i class="bi bi-image fs-1"></i>
                    <p class="mt-2 mb-0">No images uploaded yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        {% if ai_analysis %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary-subtle">
                <h5 class="card-title mb-0 text-primary"><i class="bi bi-robot me-2"></i>AI Analysis</h5>
                <small class="text-secondary">Analyzed at {{ ai_analysis.analyzed_at|date:"Y-m-d H:i" }}</small>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> This AI analysis is for decision support only. 
                    It does not replace professional radiological interpretation.
                </div>

                {% if ai_analysis.red_flags %}
                <div class="alert alert-danger">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-octagon me-2"></i>Red Flags</h6>
                    <ul class="mb-0">
                        {% for flag in ai_analysis.red_flags %}
                        <li>{{ flag }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-secondary">Case Summary</h6>
                        <p>{{ ai_analysis.case_summary|default:"-"|linebreaks }}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-secondary">Technical Assessment</h6>
                        <p>{{ ai_analysis.technical_assessment|default:"-"|linebreaks }}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-secondary">Findings</h6>
                        <p>{{ ai_analysis.findings|default:"-"|linebreaks }}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-secondary">Impression</h6>
                        <p>{{ ai_analysis.impression|default:"-"|linebreaks }}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-secondary">Recommendations</h6>
                        <p>{{ ai_analysis.recommendations|default:"-"|linebreaks }}</p>
                    </div>
                    <div class="col-12">
                        <span class="badge bg-secondary">Confidence: {{ ai_analysis.confidence_level|default:"N/A" }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-file-earmark-medical me-2"></i>Radiology Report</h5>
            </div>
            <div class="card-body">
                {% if report and report.verified_at %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Report Verified</strong> by {{ report.verified_by.get_full_name|default:"Unknown" }} 
                    on {{ report.verified_at|date:"Y-m-d H:i" }}
                </div>
                {% endif %}

                <form method="post" action="{% url 'xray:create_report' study.pk %}">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="id_technique" class="form-label">Technique</label>
                        {{ report_form.technique }}
                        {% if report and report.verified_at %}<script>document.getElementById('id_technique').readOnly = true;</script>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_findings" class="form-label">Findings <span class="text-danger">*</span></label>
                        {{ report_form.findings }}
                        {% if report and report.verified_at %}<script>document.getElementById('id_findings').readOnly = true;</script>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_impression" class="form-label">Impression <span class="text-danger">*</span></label>
                        {{ report_form.impression }}
                        {% if report and report.verified_at %}<script>document.getElementById('id_impression').readOnly = true;</script>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_recommendations" class="form-label">Recommendations</label>
                        {{ report_form.recommendations }}
                        {% if report and report.verified_at %}<script>document.getElementById('id_recommendations').readOnly = true;</script>{% endif %}
                    </div>

                    {% if not report or not report.verified_at %}
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Save Report
                        </button>
                        {% if ai_analysis %}
                        <button type="button" class="btn btn-outline-secondary" onclick="copyFromAI()">
                            <i class="bi bi-clipboard"></i> Copy from AI Analysis
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-file-earmark me-2"></i>Supporting Documents</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadDocModal">
                    <i class="bi bi-upload"></i> Upload Document
                </button>
            </div>
            <div class="card-body">
                {% if documents %}
                <ul class="list-group list-group-flush">
                    {% for doc in documents %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ doc.document.url }}" target="_blank">{{ doc.title }}</a>
                            <br><small class="text-secondary">{{ doc.get_doc_type_display }} | {{ doc.uploaded_at|date:"Y-m-d H:i" }}</small>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-3 text-secondary">
                    <p class="mb-0">No documents uploaded</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadImageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'xray:upload_image' study.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Upload X-Ray Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="image" class="form-label">Image File <span class="text-danger">*</span></label>
                        <input type="file" name="image" id="image" class="form-control" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" name="description" id="description" class="form-control" placeholder="e.g., Chest PA view">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'xray:upload_document' study.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Upload Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="doc_type" class="form-label">Document Type</label>
                        <select name="doc_type" id="doc_type" class="form-select">
                            <option value="referral">Referral Letter</option>
                            <option value="previous_report">Previous Report</option>
                            <option value="clinical_notes">Clinical Notes</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" name="title" id="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="document" class="form-label">File <span class="text-danger">*</span></label>
                        <input type="file" name="document" id="document" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if ai_analysis %}
{{ ai_analysis.findings|json_script:"ai-findings" }}
{{ ai_analysis.impression|json_script:"ai-impression" }}
{{ ai_analysis.recommendations|json_script:"ai-recommendations" }}
<script>
function copyFromAI() {
    var findings = JSON.parse(document.getElementById('ai-findings').textContent);
    var impression = JSON.parse(document.getElementById('ai-impression').textContent);
    var recommendations = JSON.parse(document.getElementById('ai-recommendations').textContent);
    document.getElementById('id_findings').value = findings || "";
    document.getElementById('id_impression').value = impression || "";
    document.getElementById('id_recommendations').value = recommendations || "";
}
</script>
{% endif %}
{% endblock %}
