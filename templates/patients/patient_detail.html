{% extends 'base.html' %}

{% block title %}{{ patient.full_name }}{% endblock %}
{% block page_title %}Patient Details{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person"></i> Patient Information
            </div>
            <div class="card-body">
                <h5>{{ patient.full_name }}</h5>
                <p class="text-muted mb-3"><code>{{ patient.patient_id }}</code></p>
                
                <table class="table table-sm">
                    <tr>
                        <td><strong>Age:</strong></td>
                        <td>{{ patient.age }} years</td>
                    </tr>
                    <tr>
                        <td><strong>Gender:</strong></td>
                        <td>{{ patient.get_gender_display }}</td>
                    </tr>
                    <tr>
                        <td><strong>DOB:</strong></td>
                        <td>{{ patient.date_of_birth }}</td>
                    </tr>
                    <tr>
                        <td><strong>Phone:</strong></td>
                        <td>{{ patient.phone }}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>{{ patient.email|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Blood Type:</strong></td>
                        <td>{{ patient.blood_type|default:"-" }}</td>
                    </tr>
                    {% if patient.panel %}
                    <tr>
                        <td><strong>Panel:</strong></td>
                        <td>{{ patient.panel.company_name }}</td>
                    </tr>
                    {% endif %}
                </table>
                
                {% if patient.allergies.exists %}
                <div class="mb-3">
                    <strong>Allergies:</strong>
                    <div class="mt-1">
                        {% for allergy in patient.allergies.all %}
                        <span class="badge bg-danger">{{ allergy.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if patient.chronic_illnesses %}
                <div class="mb-3">
                    <strong>Chronic Illnesses:</strong>
                    <p class="text-muted mb-0">{{ patient.chronic_illnesses }}</p>
                </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    <a href="{% url 'patients:visit_create_for_patient' patient.pk %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-plus"></i> New Visit
                    </a>
                    <a href="{% url 'patients:patient_edit' patient.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-pencil"></i> Edit Patient
                    </a>
                    <a href="{% url 'patients:patient_history' patient.pk %}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history"></i> View History
                    </a>
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#referralModal">
                        <i class="bi bi-envelope-paper"></i> Generate Referral Letter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clipboard2-pulse"></i> Recent Visits
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Doctor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visit in visits %}
                        <tr>
                            <td>{{ visit.visit_date|date:"M d, Y H:i" }}</td>
                            <td>{{ visit.get_visit_type_display }}</td>
                            <td>{{ visit.doctor.get_full_name|default:"-" }}</td>
                            <td>
                                {% if visit.status == 'waiting' %}
                                <span class="badge bg-warning">Waiting</span>
                                {% elif visit.status == 'in_progress' %}
                                <span class="badge bg-info">In Progress</span>
                                {% elif visit.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'patients:visit_detail' visit.pk %}" class="btn btn-outline-primary btn-action">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No visits recorded.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar-check"></i> Upcoming Appointments
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Doctor</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for apt in appointments %}
                        <tr>
                            <td>{{ apt.appointment_date }}</td>
                            <td>{{ apt.appointment_time }}</td>
                            <td>{{ apt.doctor.get_full_name|default:"-" }}</td>
                            <td>{{ apt.reason|truncatewords:5 }}</td>
                            <td><span class="badge bg-primary">{{ apt.get_status_display }}</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No upcoming appointments.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="referralModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-envelope-paper"></i> Generate AI Referral Letter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="referralForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Referred To (Doctor/Hospital)</label>
                            <input type="text" class="form-control" id="referredTo" placeholder="Dr. Smith / City Hospital">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Specialty</label>
                            <select class="form-select" id="specialty">
                                <option value="">Select Specialty</option>
                                <option value="Cardiology">Cardiology</option>
                                <option value="Orthopedics">Orthopedics</option>
                                <option value="Neurology">Neurology</option>
                                <option value="Gastroenterology">Gastroenterology</option>
                                <option value="ENT">ENT</option>
                                <option value="Ophthalmology">Ophthalmology</option>
                                <option value="Dermatology">Dermatology</option>
                                <option value="Psychiatry">Psychiatry</option>
                                <option value="General Surgery">General Surgery</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Referral</label>
                        <textarea class="form-control" id="referralReason" rows="2" placeholder="Describe reason for referral"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Clinical Notes / Findings</label>
                        <textarea class="form-control" id="clinicalNotes" rows="3" placeholder="Relevant clinical notes, examination findings, test results"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Diagnosis</label>
                            <input type="text" class="form-control" id="diagnosis" placeholder="Working diagnosis">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Treatment Given</label>
                            <input type="text" class="form-control" id="treatment" placeholder="Treatment provided so far">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="btnGenerateReferral">
                        <i class="bi bi-robot"></i> Generate Letter with AI
                    </button>
                </form>
                
                <div id="referralResult" class="mt-4 d-none">
                    <hr>
                    <h6><i class="bi bi-file-text"></i> Generated Referral Letter</h6>
                    <div class="card">
                        <div class="card-body" id="referralLetterContent" style="white-space: pre-wrap; font-family: serif;"></div>
                    </div>
                    <small class="text-muted d-block mt-2" id="referralDisclaimer"></small>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyReferralLetter()">
                            <i class="bi bi-clipboard"></i> Copy to Clipboard
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printReferralLetter()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const patientId = {{ patient.pk }};

document.getElementById('btnGenerateReferral').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
    
    const data = {
        patient_id: patientId,
        referred_to: document.getElementById('referredTo').value,
        specialty: document.getElementById('specialty').value,
        reason: document.getElementById('referralReason').value,
        clinical_notes: document.getElementById('clinicalNotes').value,
        diagnosis: document.getElementById('diagnosis').value,
        treatment: document.getElementById('treatment').value
    };
    
    fetch('/ai/api/referral-letter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> Generate Letter with AI';
        
        if (result.success) {
            const resultDiv = document.getElementById('referralResult');
            const contentDiv = document.getElementById('referralLetterContent');
            const disclaimerDiv = document.getElementById('referralDisclaimer');
            
            const letter = `${result.salutation}

${result.body}

${result.closing}`;
            
            contentDiv.textContent = letter;
            disclaimerDiv.textContent = result.disclaimer || '';
            resultDiv.classList.remove('d-none');
        } else {
            alert('Error: ' + (result.error || 'Failed to generate referral letter'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> Generate Letter with AI';
        alert('Failed to generate referral letter: ' + error.message);
    });
});

function copyReferralLetter() {
    const text = document.getElementById('referralLetterContent').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Letter copied to clipboard!');
    });
}

function printReferralLetter() {
    const content = document.getElementById('referralLetterContent').textContent;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head><title>Referral Letter</title></head>
        <body style="font-family: serif; padding: 40px; white-space: pre-wrap;">
        ${content}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}
