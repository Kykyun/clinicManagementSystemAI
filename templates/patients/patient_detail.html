{% extends 'base.html' %}

{% block title %}{{ patient.full_name }}{% endblock %}
{% block page_title %}Patient Details{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-center gap-3">
        <a href="{% url 'patients:patient_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h4><i class="bi bi-person"></i> {{ patient.full_name }}</h4>
            <code class="patient-id-badge">{{ patient.patient_id }}</code>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'patients:visit_create_for_patient' patient.pk %}" class="btn btn-primary">
            <i class="bi bi-clipboard-plus"></i> New Visit
        </a>
        <a href="{% url 'patients:patient_edit' patient.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-pencil"></i> Edit
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card patient-info-card">
            <div class="card-header">
                <i class="bi bi-person-badge"></i> Personal Information
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <i class="bi bi-calendar3"></i>
                        <div>
                            <span class="info-label">Age / DOB</span>
                            <span class="info-value">{{ patient.age }} years ({{ patient.date_of_birth|date:"M d, Y" }})</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-gender-ambiguous"></i>
                        <div>
                            <span class="info-label">Gender</span>
                            <span class="info-value">{{ patient.get_gender_display }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-telephone"></i>
                        <div>
                            <span class="info-label">Phone</span>
                            <span class="info-value">{{ patient.phone }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-envelope"></i>
                        <div>
                            <span class="info-label">Email</span>
                            <span class="info-value">{{ patient.email|default:"-" }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-droplet"></i>
                        <div>
                            <span class="info-label">Blood Type</span>
                            <span class="info-value blood-type">{{ patient.blood_type|default:"-" }}</span>
                        </div>
                    </div>
                    {% if patient.panel %}
                    <div class="info-item">
                        <i class="bi bi-building"></i>
                        <div>
                            <span class="info-label">Panel</span>
                            <span class="info-value panel-badge">{{ patient.panel.company_name }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if patient.allergies.exists %}
                <div class="allergy-alert">
                    <div class="alert-header">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Known Allergies</strong>
                    </div>
                    <div class="allergy-list">
                        {% for allergy in patient.allergies.all %}
                        <span class="badge bg-danger">{{ allergy.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if patient.chronic_illnesses %}
                <div class="chronic-section">
                    <span class="section-label">Chronic Illnesses</span>
                    <p class="chronic-text">{{ patient.chronic_illnesses }}</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="action-buttons">
                    <a href="{% url 'patients:patient_history' patient.pk %}" class="btn btn-outline-info btn-sm w-100">
                        <i class="bi bi-clock-history"></i> View Full History
                    </a>
                    <button type="button" class="btn btn-outline-warning btn-sm w-100" data-bs-toggle="modal" data-bs-target="#referralModal">
                        <i class="bi bi-envelope-paper"></i> Generate Referral
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <span><i class="bi bi-clipboard2-pulse"></i> Recent Visits</span>
                <a href="{% url 'patients:visit_create_for_patient' patient.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-lg"></i> New
                </a>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Doctor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visit in visits %}
                        <tr>
                            <td>{{ visit.visit_date|date:"M d, Y H:i" }}</td>
                            <td>
                                <span class="type-badge {{ visit.visit_type|lower }}">{{ visit.get_visit_type_display }}</span>
                            </td>
                            <td>{{ visit.doctor.get_full_name|default:"-" }}</td>
                            <td>
                                <span class="status-badge {{ visit.status }}">{{ visit.get_status_display }}</span>
                            </td>
                            <td>
                                <a href="{% url 'patients:visit_detail' visit.pk %}" class="action-btn view" title="View">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">
                                <div class="empty-state-mini">
                                    <i class="bi bi-clipboard2"></i>
                                    <span>No visits recorded yet.</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span><i class="bi bi-calendar-check"></i> Upcoming Appointments</span>
                <a href="{% url 'patients:appointment_create' %}?patient={{ patient.pk }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg"></i> Schedule
                </a>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Doctor</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for apt in appointments %}
                        <tr>
                            <td>{{ apt.appointment_date|date:"M d, Y" }}</td>
                            <td>{{ apt.appointment_time|time:"H:i" }}</td>
                            <td>{{ apt.doctor.get_full_name|default:"-" }}</td>
                            <td>{{ apt.reason|truncatewords:5 }}</td>
                            <td><span class="badge bg-primary">{{ apt.get_status_display }}</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">
                                <div class="empty-state-mini">
                                    <i class="bi bi-calendar"></i>
                                    <span>No upcoming appointments.</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="referralModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-envelope-paper"></i> Generate AI Referral Letter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="referralForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Referred To (Doctor/Hospital)</label>
                            <input type="text" class="form-control" id="referredTo" placeholder="Dr. Smith / City Hospital">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Specialty</label>
                            <select class="form-select" id="specialty">
                                <option value="">Select Specialty</option>
                                <option value="Cardiology">Cardiology</option>
                                <option value="Orthopedics">Orthopedics</option>
                                <option value="Neurology">Neurology</option>
                                <option value="Gastroenterology">Gastroenterology</option>
                                <option value="ENT">ENT</option>
                                <option value="Ophthalmology">Ophthalmology</option>
                                <option value="Dermatology">Dermatology</option>
                                <option value="Psychiatry">Psychiatry</option>
                                <option value="General Surgery">General Surgery</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Referral</label>
                        <textarea class="form-control" id="referralReason" rows="2" placeholder="Describe reason for referral"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Clinical Notes / Findings</label>
                        <textarea class="form-control" id="clinicalNotes" rows="3" placeholder="Relevant clinical notes, examination findings, test results"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Diagnosis</label>
                            <input type="text" class="form-control" id="diagnosis" placeholder="Working diagnosis">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Treatment Given</label>
                            <input type="text" class="form-control" id="treatment" placeholder="Treatment provided so far">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="btnGenerateReferral">
                        <i class="bi bi-robot"></i> Generate Letter with AI
                    </button>
                </form>
                
                <div id="referralResult" class="mt-4 d-none">
                    <hr>
                    <h6><i class="bi bi-file-text"></i> Generated Referral Letter</h6>
                    <div class="card">
                        <div class="card-body" id="referralLetterContent" style="white-space: pre-wrap; font-family: serif;"></div>
                    </div>
                    <small class="text-muted d-block mt-2" id="referralDisclaimer"></small>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyReferralLetter()">
                            <i class="bi bi-clipboard"></i> Copy to Clipboard
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printReferralLetter()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
        gap: var(--space-md);
    }
    .page-header h4 {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    .page-header h4 i {
        color: var(--primary);
    }
    .patient-id-badge {
        background: var(--primary-light);
        color: var(--primary);
        padding: 4px 12px;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-weight: 500;
    }
    .patient-info-card .card-body {
        padding: var(--space-lg);
    }
    .info-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }
    .info-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
    }
    .info-item > i {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: var(--radius-sm);
        font-size: 1rem;
        flex-shrink: 0;
    }
    .info-item .info-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 2px;
    }
    .info-item .info-value {
        display: block;
        color: var(--text-primary);
        font-weight: 500;
    }
    .blood-type {
        display: inline-block;
        background: var(--danger-light);
        color: var(--danger);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        font-weight: 600;
    }
    .panel-badge {
        display: inline-block;
        background: var(--info-light);
        color: var(--info);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }
    .allergy-alert {
        margin-top: var(--space-lg);
        padding: var(--space-md);
        background: var(--danger-light);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--danger);
    }
    .allergy-alert .alert-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        color: var(--danger);
        margin-bottom: var(--space-sm);
    }
    .allergy-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-xs);
    }
    .chronic-section {
        margin-top: var(--space-lg);
        padding-top: var(--space-md);
        border-top: 1px solid var(--border-light);
    }
    .section-label {
        display: block;
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--space-sm);
    }
    .chronic-text {
        color: var(--text-primary);
        margin: 0;
        line-height: 1.6;
    }
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    .type-badge {
        display: inline-flex;
        padding: 4px 12px;
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 500;
    }
    .type-badge.medical {
        background: var(--info-light);
        color: var(--info);
    }
    .type-badge.otc {
        background: var(--success-light);
        color: var(--success);
    }
    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        transition: all var(--transition-fast);
    }
    .action-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--primary-light);
    }
    .empty-state-mini {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        padding: var(--space-lg);
        color: var(--text-muted);
    }
    .empty-state-mini i {
        font-size: 1.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const patientId = {{ patient.pk }};

document.getElementById('btnGenerateReferral').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
    
    const data = {
        patient_id: patientId,
        referred_to: document.getElementById('referredTo').value,
        specialty: document.getElementById('specialty').value,
        reason: document.getElementById('referralReason').value,
        clinical_notes: document.getElementById('clinicalNotes').value,
        diagnosis: document.getElementById('diagnosis').value,
        treatment: document.getElementById('treatment').value
    };
    
    fetch('/ai/api/referral-letter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> Generate Letter with AI';
        
        if (result.success) {
            const resultDiv = document.getElementById('referralResult');
            const contentDiv = document.getElementById('referralLetterContent');
            const disclaimerDiv = document.getElementById('referralDisclaimer');
            
            const letter = `${result.salutation}

${result.body}

${result.closing}`;
            
            contentDiv.textContent = letter;
            disclaimerDiv.textContent = result.disclaimer || '';
            resultDiv.classList.remove('d-none');
        } else {
            alert('Error: ' + (result.error || 'Failed to generate referral letter'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> Generate Letter with AI';
        alert('Failed to generate referral letter: ' + error.message);
    });
});

function copyReferralLetter() {
    const text = document.getElementById('referralLetterContent').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Letter copied to clipboard!');
    });
}

function printReferralLetter() {
    const content = document.getElementById('referralLetterContent').textContent;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head><title>Referral Letter</title></head>
        <body style="font-family: serif; padding: 40px; white-space: pre-wrap;">
        ${content}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}
