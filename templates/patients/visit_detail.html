{% extends 'base.html' %}

{% block title %}Visit {{ visit.visit_number }}{% endblock %}
{% block page_title %}Visit Details{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-center gap-3">
        <a href="{% url 'patients:visit_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h4><i class="bi bi-clipboard2-pulse"></i> Visit Details</h4>
            <code class="visit-code">{{ visit.visit_number }}</code>
        </div>
    </div>
    <div class="d-flex gap-2">
        {% if visit.status != 'completed' %}
        <a href="{% url 'patients:complete_visit' visit.pk %}" class="btn btn-success">
            <i class="bi bi-check-lg"></i> Complete Visit
        </a>
        {% endif %}
        <a href="{% url 'finance:invoice_create_for_visit' visit.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-receipt"></i> Create Invoice
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card info-card patient-card">
            <div class="card-header">
                <i class="bi bi-person"></i> Patient Information
            </div>
            <div class="card-body">
                <div class="patient-header">
                    <h5 class="patient-name">
                        <a href="{% url 'patients:patient_detail' visit.patient.pk %}">{{ visit.patient.full_name }}</a>
                    </h5>
                    <code class="patient-id">{{ visit.patient.patient_id }}</code>
                </div>
                
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-label">Age</span>
                        <span class="info-value">{{ visit.patient.age }} years</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phone</span>
                        <span class="info-value">{{ visit.patient.phone }}</span>
                    </div>
                </div>
                
                {% if visit.patient.allergies.exists %}
                <div class="allergy-section">
                    <span class="section-label"><i class="bi bi-exclamation-triangle-fill text-danger"></i> Allergies</span>
                    <div class="allergy-badges">
                        {% for allergy in visit.patient.allergies.all %}
                        <span class="badge bg-danger">{{ allergy.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card info-card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Visit Information
            </div>
            <div class="card-body">
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-label">Queue</span>
                        <span class="queue-badge">#{{ visit.queue_number }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Type</span>
                        <span class="type-badge {{ visit.visit_type|lower }}">{{ visit.get_visit_type_display }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Date</span>
                        <span class="info-value">{{ visit.visit_date|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Doctor</span>
                        <span class="info-value">{{ visit.doctor.get_full_name|default:"Not assigned" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="status-badge {{ visit.status }}">{{ visit.get_status_display }}</span>
                    </div>
                </div>
                {% if visit.reason %}
                <div class="reason-section">
                    <span class="section-label">Reason for Visit</span>
                    <p class="reason-text">{{ visit.reason }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        {% if consultation %}
        <div class="card consultation-card">
            <div class="card-header">
                <span><i class="bi bi-stethoscope"></i> Consultation</span>
                <a href="{% url 'patients:consultation_edit' consultation.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            </div>
            <div class="card-body">
                <div class="vitals-grid">
                    <div class="vital-item">
                        <i class="bi bi-heart-pulse"></i>
                        <span class="vital-label">BP</span>
                        <span class="vital-value">{{ consultation.vitals_bp|default:"-" }}</span>
                    </div>
                    <div class="vital-item">
                        <i class="bi bi-activity"></i>
                        <span class="vital-label">Pulse</span>
                        <span class="vital-value">{{ consultation.vitals_pulse|default:"-" }} <small>bpm</small></span>
                    </div>
                    <div class="vital-item">
                        <i class="bi bi-thermometer-half"></i>
                        <span class="vital-label">Temp</span>
                        <span class="vital-value">{{ consultation.vitals_temp|default:"-" }} <small>Â°C</small></span>
                    </div>
                </div>
                
                <div class="consultation-section">
                    <h6><i class="bi bi-chat-left-text"></i> Chief Complaint</h6>
                    <p>{{ consultation.chief_complaint }}</p>
                </div>
                
                <div class="consultation-section">
                    <h6><i class="bi bi-clipboard2-check"></i> Diagnosis</h6>
                    <p>{{ consultation.diagnosis }}</p>
                </div>
                
                {% if consultation.treatment_plan %}
                <div class="consultation-section">
                    <h6><i class="bi bi-capsule"></i> Treatment Plan</h6>
                    <p>{{ consultation.treatment_plan }}</p>
                </div>
                {% endif %}
                
                <a href="{% url 'patients:consultation_detail' consultation.pk %}" class="btn btn-outline-primary btn-sm mt-2">
                    <i class="bi bi-eye"></i> View Full Consultation
                </a>
            </div>
        </div>
        {% else %}
        <div class="card empty-consultation-card">
            <div class="card-body">
                <div class="empty-state">
                    <i class="bi bi-stethoscope"></i>
                    <h5>No Consultation Yet</h5>
                    <p>This visit doesn't have a consultation recorded.</p>
                    {% if visit.status != 'completed' %}
                    <a href="{% url 'patients:consultation_create' visit.pk %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Start Consultation
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
        gap: var(--space-md);
    }
    .page-header h4 {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    .page-header h4 i {
        color: var(--primary);
    }
    .visit-code {
        background: var(--primary-light);
        color: var(--primary);
        padding: 4px 12px;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-weight: 500;
    }
    .info-card .card-body {
        padding: var(--space-lg);
    }
    .patient-header {
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 1px solid var(--border-light);
    }
    .patient-name {
        margin: 0 0 var(--space-xs) 0;
        font-size: var(--font-size-xl);
    }
    .patient-name a {
        color: var(--text-primary);
        text-decoration: none;
    }
    .patient-name a:hover {
        color: var(--primary);
    }
    .patient-id {
        background: var(--primary-light);
        color: var(--primary);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
    }
    .info-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--border-light);
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .info-label {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        font-weight: 500;
    }
    .info-value {
        color: var(--text-primary);
        font-weight: 500;
    }
    .queue-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        background: var(--secondary);
        color: var(--text-inverse);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--font-size-sm);
    }
    .type-badge {
        display: inline-flex;
        padding: 4px 12px;
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 500;
    }
    .type-badge.medical {
        background: var(--info-light);
        color: var(--info);
    }
    .type-badge.otc {
        background: var(--success-light);
        color: var(--success);
    }
    .allergy-section, .reason-section {
        margin-top: var(--space-lg);
        padding-top: var(--space-md);
        border-top: 1px solid var(--border-light);
    }
    .section-label {
        display: block;
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--space-sm);
    }
    .allergy-badges {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-xs);
    }
    .reason-text {
        color: var(--text-primary);
        margin: 0;
    }
    .consultation-card .card-body {
        padding: var(--space-lg);
    }
    .vitals-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-md);
        padding: var(--space-md);
        background: var(--background);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
    }
    .vital-item {
        text-align: center;
        padding: var(--space-md);
    }
    .vital-item i {
        font-size: 1.5rem;
        color: var(--primary);
        display: block;
        margin-bottom: var(--space-xs);
    }
    .vital-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--space-xs);
    }
    .vital-value {
        display: block;
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--text-primary);
    }
    .vital-value small {
        font-size: var(--font-size-sm);
        font-weight: 400;
        color: var(--text-secondary);
    }
    .consultation-section {
        margin-bottom: var(--space-lg);
    }
    .consultation-section h6 {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--space-sm);
    }
    .consultation-section h6 i {
        color: var(--primary);
    }
    .consultation-section p {
        color: var(--text-primary);
        line-height: 1.6;
        margin: 0;
        padding-left: calc(1em + var(--space-sm));
    }
    .empty-consultation-card .card-body {
        padding: var(--space-2xl);
    }
    .empty-state {
        text-align: center;
        color: var(--text-secondary);
    }
    .empty-state i {
        font-size: 4rem;
        color: var(--text-muted);
        margin-bottom: var(--space-md);
        display: block;
    }
    .empty-state h5 {
        margin-bottom: var(--space-sm);
        color: var(--text-primary);
    }
    .empty-state p {
        margin-bottom: var(--space-lg);
    }
</style>
{% endblock %}
